<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>
    text {
      font-family: Helvetica, sans;
      fill :steelblue
    }
    g {
      stroke-width: 1;
    }
    rect {
      fill: none;
    }
  </style>
</head>
<body>


<script src="http://d3js.org/d3.v4.js"></script>
<script src="./lib/d3-gridding.js" charset="utf-8"></script>
<script>

const w = 800,
  h = 600,
  glyphs = ["😀","😃","😉","😐","😕","😞","😢","😠"],
  data = glyphs.map( d => Object({ glyph : d, count : Math.floor(Math.random()*100)+1})) // add random value btw 1 and 100 for testing purposes
  // color = d3.scaleOrdinal(d3.schemeCategory10);

  color = d3.scaleLinear()
          .domain([ d3.min(data.map(d => d.count)), d3.max(data.map(d => d.count))])
          .range(["#FFF", "steelblue"]);

const grid = d3.select("body")
  .append("svg")
    .attr("width", w)
    .attr("height", h)
  .append("g")
    .attr("class", "grid");

const gridding = d3.gridding()
  .size([w, h])
  .mode("grid")
  .padding(5)
//
const items = grid.selectAll(".grid-item")
    .data(gridding(d3.range(d3.gridding().modes().length)));

items.enter()
  .append("g")
    .attr("class", "grid-item")


d3.selectAll(".grid-item").each( function(d,i) {
  d3.select(this)
    .append("rect")
      .attr("width", d.width)
      .attr("height", d.height)
      .attr("transform", d => "translate(" + d.x + "," + d.y + ")" )
      .style("stroke", "#ccc")
      .style("stroke-width", 1)
})

d3.selectAll(".grid-item")
  .each( function(g,i) { // arrow function 'this' see #2644 #2246

      // build sub grid from grid-item coordinate
      let subGrid = d3.gridding()
            .size([g.width, g.height])
            .offset([g.x, g.y])
            .mode(d3.gridding().modes()[i])

      let gridItems = d3.select(this)
        .selectAll(".grid-sub-item")
        .data(subGrid(data), d => d.count)

      var ha = gridItems.enter()
        .append("g")
        .attr("class", "grid-sub-item")

        ha.append("rect")
            .attr("width", d => d.width)
            .attr("height", d => d.height)
            .attr("transform", d => "translate(" + d.x + "," + d.y + ")" )
            .style("fill", (d,i) => color(d.count))
            .text(d => d.glyph)

        ha.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", d => "translate(" + d.x + "," + d.y + ")" )
            // .attr("transform", d => "translate(" + (d.x+d.width/2) + "," + (d.y+d.height/2) + ")" )
            // .style("fill", (d,i) => d3.hsl(color(d.count)).l < .2 ? "black" : "white")
            .style("fill", d => color(d.count))
            .text(d => d.glyph)


      d3.select(this)
        .append("text")
          .attr("text-anchor", "middle")
          .attr("x", g.x + g.width/2)
          .attr("y", g.y + g.height/2)
          .text((i+1) + ". " +d3.gridding().modes()[i].toUpperCase())
          .style("font-size", "12px")
          // .style("fill", [0,1,2,6,8,,10,11,12].indexOf(i) > -1 ? "white" : "steelblue" ) //make caption readable
    })

</script>
</body>
